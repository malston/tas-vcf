# TAS 6.0.6 on VCF 9 Homelab - Design Document

**Date:** 2025-11-25
**Status:** Approved

## Overview

Deploy Tanzu Application Service (TAS) 6.0.6 to a VCF 9 homelab environment using a two-phase approach:

1. **Phase 1: IaaS Paving (Terraform)** - Create NSX-T networking topology and vSphere resources
2. **Phase 2: TAS Deployment (Platform Automation Toolkit)** - Deploy Ops Manager, BOSH Director, and TAS

## Target Environment

| Component | Value |
|-----------|-------|
| vCenter | vc01.vcf.lab |
| NSX Manager | nsx01.vcf.lab |
| ESXi Hosts | esx01-03.vcf.lab (172.30.0.11-13) |
| vSphere Cluster | VCF-Mgmt-Cluster |
| TAS Domain | tas.vcf.lab |
| TAS Version | 6.0.6 |

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| NSX approach | Traditional T0→T1→Segment | VPC-native approach deferred for future Tanzu Platform 10.3+ |
| T0 Router | Reuse existing VCF T0 | Already configured with edge cluster and external connectivity |
| IP scheme | Internal: 10.0.x.0/24, External: 31.31.10.x | Separate from VPC ranges (172.26.x, 31.31.0.x) for clarity |
| Availability Zones | 2 AZs (esx02, esx03) | esx01 reserved for infrastructure (already hosts VCF components) |
| Storage | vSAN | Shared storage enables vMotion, standard for VCF |
| DNS | Wildcards in Pi-hole → LB VIPs | Simple, covers all TAS endpoints |
| Certificates | Self-signed | Appropriate for homelab |

## Architecture

### NSX-T Networking

#### T1 Routers

| Router | Purpose | Edge Cluster Binding |
|--------|---------|---------------------|
| T1-TAS-Infrastructure | Ops Manager, BOSH Director | Yes (for NAT) |
| T1-TAS-Deployment | Diego cells, Routers, UAA, etc. | Yes (for LB) |
| T1-TAS-Services | On-demand service instances | Yes |

#### Segments

| Segment | CIDR | Gateway | Connected To |
|---------|------|---------|--------------|
| TAS-Infrastructure | 10.0.1.0/24 | 10.0.1.1 | T1-TAS-Infrastructure |
| TAS-Deployment | 10.0.2.0/24 | 10.0.2.1 | T1-TAS-Deployment |
| TAS-Services | 10.0.3.0/24 | 10.0.3.1 | T1-TAS-Services |

#### NAT Rules (on existing T0)

| Rule | Type | Match | Translated |
|------|------|-------|------------|
| TAS-SNAT-All | SNAT | 10.0.0.0/16 | 31.31.10.1 |
| TAS-SNAT-OpsMan | SNAT | 10.0.1.10 | 31.31.10.10 |
| TAS-DNAT-OpsMan | DNAT | 31.31.10.10 | 10.0.1.10 |

#### Container Networking

| Resource | Value | Purpose |
|----------|-------|---------|
| External IP Pool | 31.31.10.100-200 | Per-org NAT for outbound container traffic |
| Container IP Block | 10.12.0.0/14 | Internal container-to-container networking |

### NSX-T Load Balancers

**Load Balancer Service:** Attached to T1-TAS-Deployment (Small size)

#### Virtual Servers

| Name | VIP | Port(s) | Pool | Health Check |
|------|-----|---------|------|--------------|
| TAS-Web-HTTP | 31.31.10.20 | 80 | GoRouter pool | HTTP /health:8080 |
| TAS-Web-HTTPS | 31.31.10.20 | 443 | GoRouter pool | HTTP /health:8080 |
| TAS-TCP | 31.31.10.22 | 1024-65535 | TCP Router pool | HTTP /health:80 |
| TAS-SSH | 31.31.10.21 | 2222 | Diego Brain pool | TCP 2222 |

#### Server Pools

| Pool | Algorithm | SNAT | Members |
|------|-----------|------|---------|
| GoRouter | ROUND_ROBIN | Auto | Registered by BOSH |
| TCP Router | ROUND_ROBIN | Transparent | Registered by BOSH |
| Diego Brain | ROUND_ROBIN | Transparent | Registered by BOSH |

### vSphere Resources

#### Resource Pools

| Resource Pool | Purpose | Host Affinity |
|---------------|---------|---------------|
| tas-infrastructure | Ops Manager, BOSH Director | esx01 (DRS rule) |
| tas-az1 | TAS workload VMs - AZ1 | esx02 (DRS rule) |
| tas-az2 | TAS workload VMs - AZ2 | esx03 (DRS rule) |

#### VM Organization

| Path | Purpose |
|------|---------|
| /tas/vms | All TAS VMs |
| /tas/templates | BOSH stemcell templates |
| /tas/disks | BOSH persistent disks |

#### BOSH AZ Mapping

| BOSH AZ | vSphere Resource Pool | vSphere Cluster |
|---------|----------------------|-----------------|
| az1 | tas-az1 | VCF-Mgmt-Cluster |
| az2 | tas-az2 | VCF-Mgmt-Cluster |

#### Network Mappings

| BOSH Network | vSphere Segment | CIDR |
|--------------|-----------------|------|
| infrastructure | TAS-Infrastructure | 10.0.1.0/24 |
| deployment | TAS-Deployment | 10.0.2.0/24 |
| services | TAS-Services | 10.0.3.0/24 |

### DNS Configuration

DNS entries in Pi-hole/Unbound (192.168.10.2):

| Record | Type | Value | Purpose |
|--------|------|-------|---------|
| opsman.tas.vcf.lab | A | 31.31.10.10 | Ops Manager UI |
| *.sys.tas.vcf.lab | A | 31.31.10.20 | System domain |
| *.apps.tas.vcf.lab | A | 31.31.10.20 | Apps domain |
| ssh.sys.tas.vcf.lab | A | 31.31.10.21 | CF SSH access |
| tcp.tas.vcf.lab | A | 31.31.10.22 | TCP router |

### TLS Certificates

Self-signed certificates generated by Terraform:

| Certificate | SANs |
|-------------|------|
| Ops Manager | opsman.tas.vcf.lab |
| TAS System | *.sys.tas.vcf.lab,*.login.sys.tas.vcf.lab, *.uaa.sys.tas.vcf.lab |
| TAS Apps | *.apps.tas.vcf.lab |

## Project Structure

```
tas-vcf/
├── terraform/
│   ├── nsxt/              # NSX-T paving (T1s, segments, NAT, LBs)
│   ├── vsphere/           # vSphere resources (resource pools, folders)
│   └── certs/             # Self-signed certificate generation
├── foundations/
│   └── vcf/               # Platform Automation config
│       ├── config/        # Tile configs (director.yml, tas.yml)
│       ├── vars/          # Environment-specific variables
│       ├── versions/      # Product versions
│       └── state/         # Ops Manager state file
├── pipelines/             # Concourse pipeline definitions
├── scripts/               # Helper scripts (DNS setup, etc.)
└── docs/                  # Design docs, runbooks
```

## Implementation Workflow

1. **Terraform NSX-T:** `terraform apply` in `terraform/nsxt/`
   - Creates T1 routers, segments, NAT rules, LB objects
   - Outputs: segment IDs, LB pool IDs, VIPs

2. **Terraform vSphere:** `terraform apply` in `terraform/vsphere/`
   - Creates resource pools, VM folders
   - Outputs: resource pool paths, folder paths

3. **Generate Configs:** Terraform outputs populate `foundations/vcf/vars/`

4. **Set Pipeline:** Configure Concourse pipeline (in tanzu-homelab) targeting VCF 9

5. **Deploy TAS:** Pipeline executes:
   - Create Ops Manager VM
   - Configure BOSH Director
   - Upload and configure TAS 6.0.6
   - Apply changes

## Terraform Providers

| Provider | Version | Purpose |
|----------|---------|---------|
| nsxt | ~> 3.x | NSX-T resources |
| vsphere | ~> 2.x | vSphere resources |
| tls | ~> 4.x | Certificate generation |

## External Dependencies

- **Concourse:** Existing instance in tanzu-homelab
- **Platform Automation Toolkit:** Downloaded from Broadcom
- **TAS 6.0.6 Tile:** Downloaded from Broadcom
- **Stemcells:** Downloaded from Broadcom

## Future Considerations

- **VPC-Native Approach:** Explore for Tanzu Platform for Cloud Foundry 10.3+
- **Additional Tiles:** Healthwatch, App Autoscaler, etc.
- **HA Concourse:** Currently using existing single instance
